<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GEE Chatbot – Dynamic World Explorer</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe, #f9fafb);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    .left-panel {
      width: 390px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      padding: 18px 18px 14px;
    }

    h2 {
      margin: 0 0 4px;
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .controls {
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .controls-title {
      font-weight: 600;
      color: #111827;
    }

    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }

    label {
      font-size: 11px;
      color: #6b7280;
      display: block;
      margin-bottom: 4px;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      outline: none;
      background: #ffffff;
      transition: border-color 0.15s, box-shadow 0.15s, transform 0.05s;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.22);
      transform: translateY(-0.5px);
    }

    .controls-footer {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
    }

    .msg {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      max-width: 90%;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.4;
      display: inline-block;
    }

    .msg.user {
      background: #dbeafe;
      margin-left: auto;
    }

    .msg.bot {
      background: #f3f4f6;
      margin-right: auto;
    }

    .msg img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 5px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    #user-input {
      flex: 1;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #user-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    button {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
      transition: background 0.15s, transform 0.08s, box-shadow 0.15s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.45);
    }

    button:disabled {
      background: #9ca3af;
      box-shadow: none;
      cursor: default;
      transform: none;
    }

    .small-btn {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      box-shadow: none;
    }

    .small-btn:hover:not(:disabled) {
      background: #f3f4ff;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.3);
      transform: translateY(-0.5px);
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      min-width: 0;
      position: relative;
    }

    .right-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .right-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .right-caption {
      font-size: 12px;
      color: #6b7280;
    }

    .map-legend-wrapper {
      flex: 1;
      display: flex;
      gap: 12px;
      min-height: 340px;
    }

    #map {
      flex: 1;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .legend-panel {
      width: 220px;
      max-width: 230px;
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 8px;
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    .legend-title {
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      row-gap: 6px;
      column-gap: 8px;
      align-items: center;
    }

    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
    }

    .swatch-water   { background: #4a90e2; }
    .swatch-trees   { background: #1b7837; }
    .swatch-grass   { background: #7fbf7b; }
    .swatch-flooded { background: #8073ac; }
    .swatch-crops   { background: #fdae61; }
    .swatch-built   { background: #d73027; }
    .swatch-bare    { background: #b8a27a; }

    .layer-toggle {
      font-size: 11px;
      background: #f9fafb;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .layer-toggle-title {
      font-weight: 600;
      color: #4b5563;
      margin-right: 4px;
    }

    .layer-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 7px;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .layer-chip input {
      cursor: pointer;
    }

    .layer-chip.active {
      background: #2563eb;
      color: white;
      border-color: #1d4ed8;
    }

    .layer-chip span {
      font-size: 11px;
    }

    @media (max-width: 900px) {
      .app-container {
        flex-direction: column;
        height: auto;
      }
      .left-panel {
        width: 100%;
      }
      .map-legend-wrapper {
        flex-direction: column;
      }
      .legend-panel {
        width: 100%;
        max-width: none;
        order: -1; /* legend above map on small screens */
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <h2>
        GEE Chatbot
        <span class="badge">Beta</span>
      </h2>
      <div class="subtitle">Explore Dynamic World land cover with AI + maps.</div>

      <!-- Controls -->
      <div class="controls">
        <div class="controls-header">
          <div class="controls-title">Analysis settings</div>
          <div class="pill">Step 1 · Configure</div>
        </div>

        <div class="controls-row">
          <div style="flex:1">
            <label for="year-a">Year A</label>
            <select id="year-a">
              <option>2020</option>
              <option>2021</option>
              <option>2022</option>
              <option>2023</option>
              <option selected>2024</option>
            </select>
          </div>
          <div style="flex:1">
            <label for="year-b">Year B</label>
            <select id="year-b">
              <option selected>2020</option>
              <option>2021</option>
              <option>2022</option>
              <option>2023</option>
              <option>2024</option>
            </select>
          </div>
        </div>

        <div class="controls-row">
          <div style="flex:1">
            <label for="function-select">Function</label>
            <select id="function-select">
              <option value="change_detection" selected>Change detection</option>
              <option value="single_year">Single year map</option>
              <option value="timeseries">Time-series summary</option>
            </select>
          </div>
          <div style="flex:1">
            <label for="location-input">Location bounds (optional)</label>
            <input
              id="location-input"
              type="text"
              placeholder="minLon,minLat,maxLon,maxLat  OR lat,lon"
            />
          </div>
        </div>

        <div class="controls-footer">
          <button id="use-map" class="small-btn" title="Use the current map view as bounds">
            Use map view
          </button>
          <div class="hint">
            Leave empty to use the default Abu Dhabi AOI.
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages" id="messages"></div>

      <!-- Chat input -->
      <div class="input-row">
        <input
          id="user-input"
          type="text"
          placeholder="Optional: ask a question about the change"
        />
        <button id="send-btn">
          ▶ Run
        </button>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <div class="right-header">
        <div>
          <div class="right-title">Interactive map</div>
          <div class="right-caption" id="map-location-label">
            Waiting for first analysis…
          </div>
        </div>

        <div class="layer-toggle" id="layer-toggle">
          <span class="layer-toggle-title">Layer</span>
          <label class="layer-chip active">
            <input type="radio" name="map-layer" value="satellite" checked />
            <span>Satellite</span>
          </label>
          <label class="layer-chip">
            <input type="radio" name="map-layer" value="dw_a" />
            <span>DW · Year A</span>
          </label>
          <label class="layer-chip">
            <input type="radio" name="map-layer" value="dw_b" />
            <span>DW · Year B</span>
          </label>
          <label class="layer-chip">
            <input type="radio" name="map-layer" value="dw_change" />
            <span>DW · Change</span>
          </label>
        </div>
      </div>

      <div class="map-legend-wrapper">
        <div id="map"></div>

        <div class="legend-panel">
          <div class="legend-title">Dynamic World classes</div>
          <div class="legend-grid">
            <div class="legend-swatch swatch-water"></div><div>0 – Water</div>
            <div class="legend-swatch swatch-trees"></div><div>1 – Trees</div>
            <div class="legend-swatch swatch-grass"></div><div>2 – Grass</div>
            <div class="legend-swatch swatch-flooded"></div><div>3 – Flooded veg</div>
            <div class="legend-swatch swatch-crops"></div><div>4 – Crops</div>
            <div class="legend-swatch swatch-built"></div><div>6 – Built</div>
            <div class="legend-swatch swatch-bare"></div><div>7 – Bare ground</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Backend origin ("" = same origin)
    const BACKEND_URL = "";

    // DOM elements
    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const yearASelect = document.getElementById("year-a");
    const yearBSelect = document.getElementById("year-b");
    const functionSelect = document.getElementById("function-select");
    const locationBoundsInput = document.getElementById("location-input");
    const useMapBtn = document.getElementById("use-map");
    const mapLocationLabel = document.getElementById("map-location-label");
    const layerToggle = document.getElementById("layer-toggle");

    let lastRequestedBBox = null;

    function addMessage(text, sender = "bot", images = []) {
      const div = document.createElement("div");
      div.className = "msg " + sender;
      div.textContent = text;

      images.forEach((url) => {
        if (!url) return;
        const img = document.createElement("img");
        img.src = url;
        div.appendChild(document.createElement("br"));
        div.appendChild(img);
      });

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Leaflet map
    const map = L.map("map").setView([24.45, 54.42], 11);

    const satelliteLayer = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19 }
    ).addTo(map);

    let dwLayer = null;
    const dwTiles = { a: null, b: null, change: null };

    function ensureDwLayer(initialUrl) {
      if (!dwLayer) {
        dwLayer = L.tileLayer(initialUrl || "", { maxZoom: 18 });
      } else if (initialUrl) {
        dwLayer.setUrl(initialUrl);
      }
      return dwLayer;
    }

    function setMapLayer(mode) {
      // update chip styles
      document
        .querySelectorAll(".layer-chip")
        .forEach((chip) => chip.classList.remove("active"));
      const chip = document.querySelector(
        `.layer-chip input[value="${mode}"]`
      )?.parentElement;
      if (chip) chip.classList.add("active");

      if (mode === "satellite") {
        if (dwLayer && map.hasLayer(dwLayer)) {
          map.removeLayer(dwLayer);
        }
        if (!map.hasLayer(satelliteLayer)) {
          satelliteLayer.addTo(map);
        }
        return;
      }

      if (!map.hasLayer(satelliteLayer)) {
        satelliteLayer.addTo(map);
      }

      let url = null;
      if (mode === "dw_a") url = dwTiles.a;
      if (mode === "dw_b") url = dwTiles.b;
      if (mode === "dw_change") url = dwTiles.change;

      if (!url) {
        if (dwLayer && map.hasLayer(dwLayer)) {
          map.removeLayer(dwLayer);
        }
        return;
      }

      const layer = ensureDwLayer(url);
      layer.setUrl(url);
      if (!map.hasLayer(layer)) {
        layer.addTo(map);
      }
    }

    // Layer toggle events
    layerToggle.addEventListener("change", (e) => {
      if (e.target.name === "map-layer") {
        setMapLayer(e.target.value);
      }
    });

    // Use map view -> write bbox into bounds input
    useMapBtn.addEventListener("click", () => {
      const b = map.getBounds();
      const sw = b.getSouthWest();
      const ne = b.getNorthEast();
      const bboxStr = `${sw.lng.toFixed(6)},${sw.lat.toFixed(6)},${ne.lng.toFixed(
        6
      )},${ne.lat.toFixed(6)}`;
      locationBoundsInput.value = bboxStr;
      lastRequestedBBox = [sw.lng, sw.lat, ne.lng, ne.lat];
      addMessage(`Location bounds set from map view: ${bboxStr}`, "bot");
    });

    // Client-side parse for bbox so we can fit the map
    function parseLocationStringClient(str) {
      if (!str) return null;
      const parts = str.split(",").map((s) => s.trim()).filter((s) => s.length > 0);
      if (parts.length === 4) {
        const nums = parts.map(Number);
        if (nums.every((n) => !Number.isNaN(n))) {
          return { roi_bounds: nums };
        }
      } else if (parts.length === 2) {
        const a = Number(parts[0]);
        const b = Number(parts[1]);
        if (!Number.isNaN(a) && !Number.isNaN(b)) {
          let lat, lon;
          if (Math.abs(a) <= 90 && Math.abs(b) <= 180) {
            lat = a;
            lon = b;
          } else {
            lon = a;
            lat = b;
          }
          const delta = 0.05;
          const bbox = [lon - delta, lat - delta, lon + delta, lat + delta];
          return { roi_bounds: bbox };
        }
      }
      return null;
    }

    async function runAnalysis() {
      const userText = input.value.trim();
      const locationBoundsVal = locationBoundsInput.value.trim();
      const yearA = parseInt(yearASelect.value);
      const yearB = parseInt(yearBSelect.value);
      const func = functionSelect.value;

      const payload = {
        message: userText || "",
        location: locationBoundsVal || "",
        year_a: yearA,
        year_b: yearB,
        analysis_function: func
      };

      const parsed = parseLocationStringClient(locationBoundsVal);
      if (parsed && parsed.roi_bounds) {
        lastRequestedBBox = parsed.roi_bounds;
      }

      const displayLocation =
        locationBoundsVal || "default Abu Dhabi AOI";

      addMessage(
        userText ||
          `Run ${func} for ${displayLocation} (${yearA} → ${yearB})`,
        "user"
      );
      input.value = "";
      sendBtn.disabled = true;
      addMessage("Thinking...", "bot");

      try {
        const res = await fetch(BACKEND_URL + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        // remove Thinking...
        messagesDiv.removeChild(messagesDiv.lastChild);

        const botText = data.message || "No message from server.";
        const imgs = [];

        if (data.data) {
          if (data.data.dw_a_url) imgs.push(data.data.dw_a_url);
          if (data.data.dw_b_url) imgs.push(data.data.dw_b_url);
          if (data.data.change_url) imgs.push(data.data.change_url);

          dwTiles.a = data.data.dw_a_tiles || null;
          dwTiles.b = data.data.dw_b_tiles || null;
          dwTiles.change = data.data.change_tiles || null;

          // default layer: change if exists, else year A, else satellite
          let defaultMode = "satellite";
          if (dwTiles.change) defaultMode = "dw_change";
          else if (dwTiles.a) defaultMode = "dw_a";

          const radio = document.querySelector(
            `input[name="map-layer"][value="${defaultMode}"]`
          );
          if (radio) {
            radio.checked = true;
            setMapLayer(defaultMode);
          }

          // update map label only with years
          mapLocationLabel.textContent = `Dynamic World · ${data.data.year_a}–${data.data.year_b}`;
        }

        addMessage(botText, "bot", imgs);

        if (lastRequestedBBox && lastRequestedBBox.length === 4) {
          const sw = [lastRequestedBBox[1], lastRequestedBBox[0]];
          const ne = [lastRequestedBBox[3], lastRequestedBBox[2]];
          try {
            map.fitBounds([sw, ne], { padding: [20, 20] });
          } catch (e) {
            console.warn("fitBounds failed", e);
          }
        }
      } catch (err) {
        console.error(err);
        if (
          messagesDiv.lastChild &&
          messagesDiv.lastChild.textContent === "Thinking..."
        ) {
          messagesDiv.removeChild(messagesDiv.lastChild);
        }
        addMessage("Error: " + err.message, "bot");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", runAnalysis);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") runAnalysis();
    });
  </script>
</body>
</html>
