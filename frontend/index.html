<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GEE Chatbot – Abu Dhabi Dynamic World</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: linear-gradient(135deg, #f3f4f6, #e5f2ff);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    /* LEFT SIDE – chat + legend */
    .left-panel {
      width: 380px;
      max-width: 420px;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      padding: 18px 18px 14px;
    }

    .left-panel h2 {
      margin: 0 0 4px;
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 10px;
    }

    .msg {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      max-width: 90%;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.4;
      display: inline-block;
    }

    .msg.user {
      background: #dbeafe;
      align-self: flex-end;
      margin-left: auto;
    }

    .msg.bot {
      background: #f3f4f6;
      align-self: flex-start;
      margin-right: auto;
    }

    .msg img {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 5px;
    }

    .legend-container {
      margin-top: 4px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .legend-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      row-gap: 6px;
      column-gap: 8px;
      align-items: center;
    }

    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #d1d5db;
    }

    .swatch-water { background: #4a90e2; }
    .swatch-trees { background: #1b7837; }
    .swatch-grass { background: #7fbf7b; }
    .swatch-flooded { background: #8073ac; }
    .swatch-crops { background: #fdae61; }
    .swatch-built { background: #d73027; }
    .swatch-bare { background: #b8a27a; }

    .legend-label {
      color: #4b5563;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    #user-input {
      flex: 1;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #user-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-weight: 500;
      white-space: nowrap;
      transition: background 0.15s, transform 0.05s;
    }

    button:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    button:disabled {
      background: #9ca3af;
      cursor: default;
      transform: none;
    }

    /* RIGHT SIDE – map */
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      min-width: 0;
    }

    .right-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .right-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .right-caption {
      font-size: 12px;
      color: #6b7280;
    }

    #map {
      flex: 1;
      min-height: 340px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    /* Responsive: stack panels on small screens */
    @media (max-width: 900px) {
      .app-container {
        flex-direction: column;
        height: auto;
      }
      .left-panel {
        width: 100%;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- LEFT: Chat + Legend -->
    <div class="left-panel">
      <h2>GEE Chatbot</h2>
      <div class="subtitle">Abu Dhabi – Dynamic World land cover</div>

      <div class="messages" id="messages"></div>

      <div class="legend-container">
        <div class="legend-title">Legend (DW classes shown):</div>
        <div class="legend-grid">
          <div class="legend-swatch swatch-water"></div>
          <div class="legend-label">0 – Water</div>

          <div class="legend-swatch swatch-trees"></div>
          <div class="legend-label">1 – Trees</div>

          <div class="legend-swatch swatch-grass"></div>
          <div class="legend-label">2 – Grass</div>

          <div class="legend-swatch swatch-flooded"></div>
          <div class="legend-label">3 – Flooded veg</div>

          <div class="legend-swatch swatch-crops"></div>
          <div class="legend-label">4 – Crops</div>

          <div class="legend-swatch swatch-built"></div>
          <div class="legend-label">6 – Built</div>

          <div class="legend-swatch swatch-bare"></div>
          <div class="legend-label">7 – Bare</div>
        </div>
      </div>

      <div class="input-row">
        <input
          id="user-input"
          type="text"
          placeholder="Ask: Compare land cover between 2020 and 2024 in Abu Dhabi"
        />
        <button id="send-btn">Send</button>
      </div>
    </div>

    <!-- RIGHT: Interactive map -->
    <div class="right-panel">
      <div class="right-header">
        <div class="right-title">Interactive map</div>
        <div class="right-caption">View switches to the latest result</div>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Same-origin: this will call /chat on the same host
    const BACKEND_URL = "";

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    function addMessage(text, sender = "bot", images = []) {
      const div = document.createElement("div");
      div.className = "msg " + sender;
      div.textContent = text;

      images.forEach((url) => {
        if (!url) return;
        const img = document.createElement("img");
        img.src = url;
        div.appendChild(document.createElement("br"));
        div.appendChild(img);
      });

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // -------- Leaflet map setup --------
    const map = L.map("map").setView([24.45, 54.42], 11); // Abu Dhabi approx
    let currentLayer = null;

    function showTileLayer(tileUrlTemplate) {
      if (!tileUrlTemplate) return;
      if (currentLayer) {
        map.removeLayer(currentLayer);
      }
      currentLayer = L.tileLayer(tileUrlTemplate, {
        maxZoom: 18,
      }).addTo(map);
    }

    // -------- Chat logic --------
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, "user");
      input.value = "";
      sendBtn.disabled = true;
      addMessage("Thinking...", "bot");

      try {
        const res = await fetch(BACKEND_URL + "/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: text }),
        });

        if (!res.ok) {
          throw new Error("HTTP error " + res.status);
        }

        const data = await res.json();

        // Remove "Thinking..." message
        messagesDiv.removeChild(messagesDiv.lastChild);

        const botText = data.message || "No message from server.";
        const imgs = [];

        if (data.data) {
          // Static PNG images
          if (data.data.dw_a_url) imgs.push(data.data.dw_a_url);
          if (data.data.dw_b_url) imgs.push(data.data.dw_b_url);
          if (data.data.change_url) imgs.push(data.data.change_url);

          // Interactive map tiles (we'll show change layer if available, else dw_a)
          const tileTemplate =
            data.data.change_tiles ||
            data.data.dw_a_tiles ||
            data.data.dw_b_tiles;

          showTileLayer(tileTemplate);
        }

        addMessage(botText, "bot", imgs);
      } catch (err) {
        console.error(err);
        messagesDiv.removeChild(messagesDiv.lastChild);
        addMessage("Error: " + err.message, "bot");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });
  </script>
</body>
</html>
