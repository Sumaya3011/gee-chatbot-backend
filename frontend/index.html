<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GEE Chatbot – Abu Dhabi Dynamic World</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: linear-gradient(135deg, #f3f4f6, #e5f2ff);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    /* LEFT SIDE – controls + chat + legend */
    .left-panel {
      width: 380px;
      max-width: 420px;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      padding: 18px 18px 14px;
    }

    .left-panel h2 {
      margin: 0 0 4px;
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    /* Controls section */
    .controls {
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .controls-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }

    .controls-row label {
      font-size: 11px;
      color: #6b7280;
      display: block;
      margin-bottom: 2px;
    }

    .controls-row .field {
      flex: 1;
    }

    select,
    .controls input[type="text"] {
      width: 100%;
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      outline: none;
      background: #ffffff;
    }

    select:focus,
    .controls input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    /* Chat + legend */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
    }

    .msg {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      max-width: 90%;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.4;
      display: inline-block;
    }

    .msg.user {
      background: #dbeafe;
      align-self: flex-end;
      margin-left: auto;
    }

    .msg.bot {
      background: #f3f4f6;
      align-self: flex-start;
      margin-right: auto;
    }

    .msg img {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 5px;
    }

    .legend-container {
      margin-top: 2px;
      padding-top: 6px;
      border-top: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .legend-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      row-gap: 6px;
      column-gap: 8px;
      align-items: center;
    }

    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #d1d5db;
    }

    .swatch-water   { background: #4a90e2; }
    .swatch-trees   { background: #1b7837; }
    .swatch-grass   { background: #7fbf7b; }
    .swatch-flooded { background: #8073ac; }
    .swatch-crops   { background: #fdae61; }
    .swatch-built   { background: #d73027; }
    .swatch-bare    { background: #b8a27a; }

    .legend-label {
      color: #4b5563;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    #user-input {
      flex: 1;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #user-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-weight: 500;
      white-space: nowrap;
      transition: background 0.15s, transform 0.05s;
    }

    button:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    button:disabled {
      background: #9ca3af;
      cursor: default;
      transform: none;
    }

    /* RIGHT SIDE – map */
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      min-width: 0;
      position: relative;
    }

    .right-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }

    .right-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .right-caption {
      font-size: 12px;
      color: #6b7280;
    }

    #map {
      flex: 1;
      min-height: 340px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    /* Map mode toggle */
    .map-toggle {
      font-size: 12px;
      background: #f9fafb;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .map-toggle label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: #374151;
    }

    .map-toggle input {
      cursor: pointer;
    }

    /* Responsive: stack panels on small screens */
    @media (max-width: 900px) {
      .app-container {
        flex-direction: column;
        height: auto;
      }
      .left-panel {
        width: 100%;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- LEFT: Controls + Chat + Legend -->
    <div class="left-panel">
      <h2>GEE Chatbot</h2>
      <div class="subtitle">Abu Dhabi – Dynamic World land cover</div>

      <!-- Analysis controls -->
      <div class="controls">
        <div class="controls-title">Analysis settings</div>

        <div class="controls-row">
          <div class="field">
            <label for="year-a">Year A</label>
            <select id="year-a">
              <option value="2016">2016</option>
              <option value="2017">2017</option>
              <option value="2018">2018</option>
              <option value="2019">2019</option>
              <option value="2020" selected>2020</option>
              <option value="2021">2021</option>
              <option value="2022">2022</option>
              <option value="2023">2023</option>
              <option value="2024">2024</option>
            </select>
          </div>
          <div class="field">
            <label for="year-b">Year B</label>
            <select id="year-b">
              <option value="2016">2016</option>
              <option value="2017">2017</option>
              <option value="2018">2018</option>
              <option value="2019">2019</option>
              <option value="2020">2020</option>
              <option value="2021">2021</option>
              <option value="2022">2022</option>
              <option value="2023">2023</option>
              <option value="2024" selected>2024</option>
            </select>
          </div>
        </div>

        <div class="controls-row">
          <div class="field">
            <label for="function-select">Function</label>
            <select id="function-select">
              <option value="change_detection" selected>Change detection</option>
              <option value="single_year">Single year map</option>
              <option value="timeseries">Time-series summary</option>
            </select>
          </div>
          <div class="field">
            <label for="location-input">Location</label>
            <input
              id="location-input"
              type="text"
              placeholder="e.g. Abu Dhabi"
              value="Abu Dhabi"
            />
          </div>
        </div>
      </div>

      <!-- Chat messages -->
      <div class="messages" id="messages"></div>

      <!-- Legend -->
      <div class="legend-container">
        <div class="legend-title">Legend (DW classes shown):</div>
        <div class="legend-grid">
          <div class="legend-swatch swatch-water"></div>
          <div class="legend-label">0 – Water</div>

          <div class="legend-swatch swatch-trees"></div>
          <div class="legend-label">1 – Trees</div>

          <div class="legend-swatch swatch-grass"></div>
          <div class="legend-label">2 – Grass</div>

          <div class="legend-swatch swatch-flooded"></div>
          <div class="legend-label">3 – Flooded veg</div>

          <div class="legend-swatch swatch-crops"></div>
          <div class="legend-label">4 – Crops</div>

          <div class="legend-swatch swatch-built"></div>
          <div class="legend-label">6 – Built</div>

          <div class="legend-swatch swatch-bare"></div>
          <div class="legend-label">7 – Bare</div>
        </div>
      </div>

      <!-- Chat input -->
      <div class="input-row">
        <input
          id="user-input"
          type="text"
          placeholder="Optional: describe your question"
        />
        <button id="send-btn">Run</button>
      </div>
    </div>

    <!-- RIGHT: Interactive map -->
    <div class="right-panel">
      <div class="right-header">
        <div>
          <div class="right-title">Interactive map</div>
          <div class="right-caption">Switch between Satellite and DW</div>
        </div>
        <div class="map-toggle">
          <label>
            <input type="radio" name="map-mode" value="satellite" checked />
            Satellite
          </label>
          <label>
            <input type="radio" name="map-mode" value="dw" />
            Dynamic World
          </label>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Same-origin: this will call /chat on the same host
    const BACKEND_URL = "";

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    const yearASelect = document.getElementById("year-a");
    const yearBSelect = document.getElementById("year-b");
    const functionSelect = document.getElementById("function-select");
    const locationInput = document.getElementById("location-input");

    function addMessage(text, sender = "bot", images = []) {
      const div = document.createElement("div");
      div.className = "msg " + sender;
      div.textContent = text;

      images.forEach((url) => {
        if (!url) return;
        const img = document.createElement("img");
        img.src = url;
        div.appendChild(document.createElement("br"));
        div.appendChild(img);
      });

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // -------- Leaflet map setup --------
    const map = L.map("map").setView([24.45, 54.42], 11); // Abu Dhabi approx

    // Base satellite layer (original imagery)
    const satelliteLayer = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 19,
        attribution:
          "Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
      }
    ).addTo(map);

    // Dynamic World layer (from backend tiles)
    let dwLayer = null;

    function showDwLayer(tileUrlTemplate) {
      if (!tileUrlTemplate) return;

      if (dwLayer) {
        map.removeLayer(dwLayer);
      }

      dwLayer = L.tileLayer(tileUrlTemplate, {
        maxZoom: 18,
      });

      // Only add if DW mode is selected
      const dwRadio = document.querySelector(
        'input[name="map-mode"][value="dw"]'
      );
      if (dwRadio && dwRadio.checked) {
        dwLayer.addTo(map);
      }
    }

    // Map mode toggle logic
    document
      .querySelectorAll('input[name="map-mode"]')
      .forEach((inputEl) => {
        inputEl.addEventListener("change", (e) => {
          const value = e.target.value;
          if (value === "satellite") {
            if (dwLayer && map.hasLayer(dwLayer)) {
              map.removeLayer(dwLayer);
            }
          } else if (value === "dw") {
            if (dwLayer && !map.hasLayer(dwLayer)) {
              dwLayer.addTo(map);
            }
          }
        });
      });

    // -------- Chat / Analysis logic --------
    async function runAnalysis() {
      const userText = input.value.trim();       // can be empty
      const locationVal = locationInput.value.trim() || "Abu Dhabi";
      const yearA = yearASelect.value;
      const yearB = yearBSelect.value;
      const func = functionSelect.value;

      // If everything is empty (very unlikely), do nothing
      if (!userText && !locationVal && !yearA && !yearB && !func) return;

      // What we show in the chat as "user message"
      const displayText =
        userText ||
        `Run "${func}" for ${locationVal} (${yearA} → ${yearB})`;

      addMessage(displayText, "user");
      input.value = "";
      sendBtn.disabled = true;
      addMessage("Thinking...", "bot");

      // What we send to backend – real variables
      const payload = {
        message: userText,          // free-text question (can be "")
        location: locationVal,      // <<< location variable
        year_a: yearA,
        year_b: yearB,
        analysis_function: func,
      };

      try {
        const res = await fetch(BACKEND_URL + "/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("HTTP error " + res.status);
        }

        const data = await res.json();

        // Remove "Thinking..." message
        messagesDiv.removeChild(messagesDiv.lastChild);

        const botText = data.message || "No message from server.";
        const imgs = [];

        if (data.data) {
          // Static PNG images
          if (data.data.dw_a_url) imgs.push(data.data.dw_a_url);
          if (data.data.dw_b_url) imgs.push(data.data.dw_b_url);
          if (data.data.change_url) imgs.push(data.data.change_url);

          // Interactive map tiles (DW layer)
          const tileTemplate =
            data.data.change_tiles ||
            data.data.dw_a_tiles ||
            data.data.dw_b_tiles;

          showDwLayer(tileTemplate);
        }

        addMessage(botText, "bot", imgs);
      } catch (err) {
        console.error(err);
        messagesDiv.removeChild(messagesDiv.lastChild);
        addMessage("Error: " + err.message, "bot");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", runAnalysis);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        runAnalysis();
      }
    });
  </script>
</body>
</html>
